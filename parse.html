<!--canvas id="c" width=1024 height=256>
</canvas-->
<script src="js/lib/require.js"></script>
<script src="js/reqConf.js"></script>
<script>
requirejs.config(reqConf);
requirejs(["M2Parser","SEnv","wavWriter","FS"],function (P,SEnv,ww,FS) {
    FS.mount("/ram/",FS.LSFS.ramDisk());
    window.senv=new SEnv({useScriptProcessor:false,useFast:true});
    window.play=function () {
        window.stopBufSrc();
        var mzo=P.parseMML(document.querySelector("#mml").value);
        window.senv.load(mzo);
        window.senv.Start();
    };
    window.stopBufSrc=function () {
        if (window.bufSrc) window.bufSrc.stop();
        delete window.bufSrc;
    },
    window.playAsBuffer=function () {
        window.stopBufSrc();
        var mzo=P.parseMML(document.querySelector("#mml").value);
        var t=window.senv;
        t.load(mzo);
        t.toAudioBuffer().then(function (data) {
            console.log("AudioData",data);
            var source = t.context.createBufferSource();
            source.buffer = data.decodedData;
            source.connect(t.context.destination);
            if (data.loopStart!=null) {
                source.loop=true;
                source.loopStart=data.loopStart;
                source.loopEnd=data.decodedData.duration;
            }
            console.log("AudioData src",source.loopStart, source.loopEnd);
            source.start = source.start || source.noteOn;
            source.start(0);
            window.bufSrc=source;
        });
    };
    window.stop=function () {
        window.stopBufSrc();
        window.senv.Stop();
    };
    window.wav=function wav() {
        window.stopBufSrc();
        senv.wavOut().then(function (raw) {
            var wavf=ww(raw, senv.sampleRate).write();
            var fn=document.querySelector("#samples").value || "test";
            var dst=FS.get("/ram/"+fn+".wav");
            console.log(wavf);
            dst.bytes(new Uint8Array(wavf).buffer);
            dst.download();
        });
    };
    window.mzo=function () {
        var mzo=P.parseMML(document.querySelector("#mml").value);
        var fn=document.querySelector("#samples").value || "test";
        var dst=FS.get("/ram/"+fn+".mzo");
        dst.bytes(new Uint8Array(mzo).buffer);
        dst.download();

    };
    setInterval(function () {
        document.querySelector("#perf").innerText=Math.floor(senv.performance.writeRate*10)/10;
    },1000);
});
window.onload=function () {
    var s=document.querySelectorAll(".mml");
    var sel=document.querySelector("#samples");
    s.forEach(function (e) {
        var opt=document.createElement("option");
        opt.innerHTML=e.getAttribute("data-name");
        sel.appendChild(opt);
    });
    sel.addEventListener("change", function () {
        selectSample(sel.value);
    });
    selectSample("Fanfare");
};
function selectSample(name) {
    var s=document.querySelectorAll(".mml");
    s.forEach(function (e) {
        var opt=document.createElement("option");
        if (e.getAttribute("data-name")===name) {
            document.querySelector("#mml").value=e.innerHTML;
        }
    });

}
</script>
<H1>Enter MML Here</h1>

<div><select id="samples">
</select></div>
<div><textarea id="mml" rows=20 cols=80>
</textarea><br/>
<button onclick="play()">Play</button>
<button onclick="stop()">Stop</button>
<button onclick="wav()">Download wav</button>
<button onclick="mzo()">Download mzo</button>
<button onclick="playAsBuffer()">Play(Lightweight)</button>
</div>
<div>performance: x<span id="perf"></span></div>
<script class="mml" type="text/mml" data-name="Fanfare">
1[l16cdeg4]
2[l16efg>c4]
</script>
<script class="mml" type="text/mml" data-name="Monologue">
1[@label1 l16o3 (ecfd)4 (ecgc)4 @jump1]
</script>
<script class="mml" type="text/mml" data-name="Monologue2">
1-2[@label1]
1[l8 @95 v8(<cc>>c<<c>)4]
2[l8 @1   <<(cege)2(dfaf)2 ]
1-2[@jump1]
</script>
<script class="mml" type="text/mml" data-name="coin">
1[@2 o5 c16>c]
</script>
<script class="mml" type="text/mml" data-name="death">
1[o5 l64 c<c<c<c>>> v9 c<c<c<c>>>]
1[ v8 afedc32  v6 gfedc32 v4 fedc32  v2 edc32  v1 c<a+a<a<a]
</script>
<script class="mml" type="text/mml" data-name="tones">
1[ps5pa0o4]

1[@0cde]     ; PSG (rectangle)
1[@1<<cde>>] ; bass
1[@2cde]
1[@3cde]
1[@4cde]     ; sine wave
1[@8cde]     ;
1[@9cde]     ; PSG duty 1/3
1[@11ps5cde] ; PSG duty 1/7
1[@12cde]
1[@14cde]    ;
1[@16cde]
1[@20cde]    ; triangle
1[@21cde]    ; saw
1[@23cde]    ;
1[@24cde]    ;
1[@25cde]    ;
1[@30<cde>]  ;
1[@43>cde<]  ;
1[@51cde]     ;
1[@71<<cde>>]  ;
1[@95<<c>c>c]  ; noise
</script>
<script class="mml" type="text/mml" data-name="envelope">
; envelope velocity
1[ps3 cde ps10 cde]
; envelope shape
1[o5]
1[ps5 pa0 cde pa1 cde pa2 cde pa3 cde]
</script>
<script class="mml" type="text/mml" data-name="macro">
$a$[cde]
$b$[gfe]
1[l16 o5 $a$ $a$ $a$ $b$   $a$ $a$ $b$ $b$   ]
</script>
<script class="mml" type="text/mml" data-name="Ribbon">
1-3[ps5 v6]
1[l16 o3ps10 ]
2[l16ps10]
1[@dt5(cgfd)4]
2[r1]
3[r1]

1-3[@label1]
1[(cgfd)8]
2[     (ec)4 r2 (ge)4 r2 ]
1[(cgfd)4 (dafd)4 ]
2[       (ec)4 r2 (fd)4 r2]
1[(cgfd)8]
2[       (ec)4 r2 (ge)4 r2]
1[(cgfd)2 cfedcgfe (cgfe)4]
2[       (ec)4 gege fddd (c<g>)4 r2 ]

1[(cgfd)8]
2[     (ec)4 r2 (ge)4 r2 ]
1[(cgfd)4 (dafd)4 ]
2[       (ec)4 r2 (fd)4 r2]
1[(cgfd)8]
2[       (ec)4 r2 (ge)4 r2]
1[(cgfd)2 cfedcgfe (cgfe)4]
2[       (ec)4 gege fddd (c<g>)4 r2 ]

3[(r1)8]
3[ps3]
3[ o5 c2 d4e4 e2 d2]
3[    c2 d4e4 d2 r2]
3[ o5 c2 d4e4 e2 d2]
3[    e2 f4d4 c2 r2]
1-3[@jump1]
</script>
