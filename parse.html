<!--canvas id="c" width=1024 height=256>
</canvas-->
<script src="js/lib/require.js"></script>
<script src="js/reqConf.js"></script>
<script>
requirejs.config(reqConf);
requirejs(["M2Parser","SEnv","wavWriter","FS"],function (P,SEnv,ww,FS) {
    FS.mount("/ram/",FS.LSFS.ramDisk());
    window.senv=new SEnv({useScriptProcessor:false});
    window.play=function () {
        var mzo=P.parseMML(document.querySelector("#mml").value);
        window.senv.load(mzo);
        window.senv.Start();
    };
    window.stop=function () {
        window.senv.Stop();
    };
    window.wav=function wav() {
        senv.wavOut().then(function (raw) {
            var wavf=ww(raw, senv.sampleRate).write();
            var fn=document.querySelector("#samples").value || "test";
            var dst=FS.get("/ram/"+fn+".wav");
            console.log(wavf);
            dst.bytes(new Uint8Array(wavf).buffer);
            dst.download();
        });
    };
});
window.onload=function () {
    var s=document.querySelectorAll(".mml");
    var sel=document.querySelector("#samples");
    s.forEach(function (e) {
        var opt=document.createElement("option");
        opt.innerHTML=e.getAttribute("data-name");
        sel.appendChild(opt);
    });
    sel.addEventListener("change", function () {
        selectSample(sel.value);
    });
    selectSample("Fanfare");
};
function selectSample(name) {
    var s=document.querySelectorAll(".mml");
    s.forEach(function (e) {
        var opt=document.createElement("option");
        if (e.getAttribute("data-name")===name) {
            document.querySelector("#mml").value=e.innerHTML;
        }
    });

}
</script>
<H1>Enter MML Here</h1>

<div><select id="samples">
</select></div>
<div><textarea id="mml" rows=20 cols=80>
</textarea>
<button onclick="play()">Play</button>
<button onclick="stop()">Stop</button>
<button onclick="wav()">Download wav</button>
</div>
<script class="mml" type="text/mml" data-name="Fanfare">
1[l16cdeg4]
2[l16efg>c4]
</script>
<script class="mml" type="text/mml" data-name="Monologue">
1[@label1 l16o3 (ecfd)4 (ecgc)4 @jump1]
</script>
<script class="mml" type="text/mml" data-name="Monologue2">
1-2[@label1]
1[l8 @95 v8(<cc>>c<<c>)4]
2[l8 @1   <<(cege)2(dfaf)2 ]
1-2[@jump1]
</script>
<script class="mml" type="text/mml" data-name="coin">
1[@2 o5 c16>c]
</script>
<script class="mml" type="text/mml" data-name="death">
1[o5 l64 c<c<c<c>>> v9 c<c<c<c>>>]
1[ v8 afedc32  v6 gfedc32 v4 fedc32  v2 edc32  v1 c<a+a<a<a]
</script>
<script class="mml" type="text/mml" data-name="Ribbon">
1-3[ps5 v6]
1[l16 o3ps10 ]
2[l16ps10]
1[@dt5(cgfd)4]
2[r1]
3[r1]

1-3[@label1]
1[(cgfd)8]
2[     (ec)4 r2 (ge)4 r2 ]
1[(cgfd)4 (dafd)4 ]
2[       (ec)4 r2 (fd)4 r2]
1[(cgfd)8]
2[       (ec)4 r2 (ge)4 r2]
1[(cgfd)2 cfedcgfe (cgfe)4]
2[       (ec)4 gege fddd (c<g>)4 r2 ]

1[(cgfd)8]
2[     (ec)4 r2 (ge)4 r2 ]
1[(cgfd)4 (dafd)4 ]
2[       (ec)4 r2 (fd)4 r2]
1[(cgfd)8]
2[       (ec)4 r2 (ge)4 r2]
1[(cgfd)2 cfedcgfe (cgfe)4]
2[       (ec)4 gege fddd (c<g>)4 r2 ]

3[(r1)8]
3[ps3]
3[ o5 c2 d4e4 e2 d2]
3[    c2 d4e4 d2 r2]
3[ o5 c2 d4e4 e2 d2]
3[    e2 f4d4 c2 r2]
1-3[@jump1]
</script>
